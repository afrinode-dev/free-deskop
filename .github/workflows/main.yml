name: Kali-RDP-Permanent

on:
  workflow_dispatch: # Lancement manuel

jobs:
  kali-job:
    runs-on: ubuntu-latest
    timeout-minutes: 3600 # Limite max de GitHub (6 heures)

    steps:
      - name: PrÃ©paration du systÃ¨me
        run: |
          sudo apt update
          # Installation de l'interface graphique lÃ©gÃ¨re et du serveur RDP
          sudo apt install -y xfce4 xfce4-goodies xrdp

      - name: CrÃ©ation de l'utilisateur Kali
        run: |
          sudo useradd -m kali
          echo "kali:KALI_PASSWORD_123" | sudo chpasswd
          sudo usermod -aG sudo kali
          # Force l'utilisation de XFCE pour cet utilisateur
          echo "xfce4-session" > /home/kali/.xsession
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Connexion Tailscale (VPN)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # Utilisation du mode userspace pour Ã©viter les erreurs de permissions rÃ©seau
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-gh-runner

      - name: Boucle Anti-Fermeture (Maintien en vie)
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "ðŸš€ KALI EST PRÃŠT !"
          echo "ðŸ“ IP TAILSCALE : $TS_IP"
          echo "ðŸ‘¤ UTILISATEUR  : kali"
          echo "ðŸ”‘ MOT DE PASSE : KALI_PASSWORD_123"
          echo "=========================================="
          
          # Cette boucle empÃªche GitHub de couper le job.
          # Elle Ã©crit dans la console toutes les 5 minutes pour simuler une activitÃ©.
          while true; do
            echo "[$(date)] RDP toujours actif... Ne pas fermer cet onglet."
            # VÃ©rifie si le service RDP tourne toujours
            pgrep xrdp > /dev/null || sudo systemctl start xrdp
            sleep 300
          done
