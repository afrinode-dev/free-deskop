name: Kali-RDP-Stable

on:
  workflow_dispatch:

jobs:
  kali-job:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Installation de l'interface graphique
        run: |
          sudo apt-get update
          # On installe XFCE et XRDP sans les th√®mes Kali pour √©viter l'erreur 100
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          
      - name: Configuration de l'utilisateur
        run: |
          sudo useradd -m kali
          echo "kali:KALI_PASSWORD_123" | sudo chpasswd
          sudo usermod -aG sudo kali
          
          # Configuration de la session pour l'utilisateur kali
          sudo -u kali bash -c "echo xfce4-session > /home/kali/.xsession"
          
          # Red√©marrage du service RDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Connexion Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-linux-gh

      - name: Installation des outils de base
        run: |
          # On installe nmap qui est disponible partout
          sudo apt-get install -y nmap
          echo "Si vous voulez plus d'outils, installez-les une fois connect√© au RDP via 'sudo apt install'."

      - name: Maintien de la connexion
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "üöÄ SERVEUR PR√äT !"
          echo "üìç IP TAILSCALE : $TS_IP"
          echo "üë§ UTILISATEUR  : kali"
          echo "üîë MOT DE PASSE : KALI_PASSWORD_123"
          echo "=========================================="
          
          while true; do
            echo "[$(date)] Runner actif sur $TS_IP"
            sleep 300
          done
