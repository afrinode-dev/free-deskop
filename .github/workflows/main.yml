name: Kali-RDP-Fixed-Session

on:
  workflow_dispatch:

jobs:
  kali-job:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Installation du systÃ¨me graphique
        run: |
          sudo apt-get update
          # Installation forcÃ©e des composants manquants pour Ã©viter l'erreur failsafe
          sudo apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils
          
      - name: Configuration de l'utilisateur et de la Session
        run: |
          sudo useradd -m kali
          echo "kali:KALI_PASSWORD_123" | sudo chpasswd
          sudo usermod -aG sudo kali
          
          # Nettoyage des sessions prÃ©cÃ©dentes et forÃ§age de XFCE
          sudo -u kali bash -c "echo 'exec startxfce4' > /home/kali/.xsession"
          sudo -u kali bash -c "chmod +x /home/kali/.xsession"
          
          # Configurer XRDP pour utiliser le bon environnement
          sudo sed -i 's/test -x \/etc\/X11\/Xsession \&\& exec \/etc\/X11\/Xsession/exec startxfce4/g' /etc/xrdp/startwm.sh
          
          sudo systemctl restart xrdp
          sudo systemctl enable xrdp

      - name: Connexion Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-linux-gh

      - name: Maintien de la connexion
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "ðŸš€ SERVEUR CORRIGÃ‰ !"
          echo "ðŸ“ IP TAILSCALE : $TS_IP"
          echo "ðŸ‘¤ UTILISATEUR  : kali"
          echo "ðŸ”‘ MOT DE PASSE : KALI_PASSWORD_123"
          echo "=========================================="
          
          while true; do
            echo "[$(date)] Session active sur $TS_IP"
            # VÃ©rification que dbus tourne pour Ã©viter l'erreur failsafe
            pgrep dbus-daemon > /dev/null || sudo service dbus start
            sleep 300
          done
