name: Kali-RDP-Fix

on:
  workflow_dispatch:

jobs:
  kali-job:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Pr√©paration du syst√®me
        run: |
          sudo apt update
          # Installation interface graphique et serveur RDP
          sudo apt install -y xfce4 xfce4-goodies xrdp kali-themes
          
      - name: Cr√©ation de l'utilisateur Kali
        run: |
          sudo useradd -m kali
          echo "kali:KALI_PASSWORD_123" | sudo chpasswd
          sudo usermod -aG sudo kali
          
          # FIX: Cr√©ation du fichier .xsession avec les bons droits
          sudo -u kali bash -c "echo xfce4-session > /home/kali/.xsession"
          
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Installation de Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=kali-linux-gh

      - name: (Optionnel) Installation Outils de base
        run: |
          # Installe nmap et metasploit pour avoir de quoi travailler
          sudo apt install -y nmap metasploit-framework

      - name: Maintien de la connexion (Boucle infinie)
        run: |
          TS_IP=$(tailscale ip -4)
          echo "=========================================="
          echo "üöÄ KALI EST PR√äT !"
          echo "üìç IP TAILSCALE : $TS_IP"
          echo "üë§ UTILISATEUR  : kali"
          echo "üîë MOT DE PASSE : KALI_PASSWORD_123"
          echo "=========================================="
          
          # Boucle de maintien avec affichage de l'heure
          while true; do
            echo "[$(date)] Serveur en ligne - IP: $TS_IP"
            sleep 300
          done
